<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Waliko Car Hire - Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background: #f4f6f9; margin: 0; padding: 0; }
    header { background: #1464dd; color: #fff; padding: 15px; text-align: center; font-size: 20px; font-weight: bold; }
    nav { background: #fff; padding: 10px; text-align: center; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 100; }
    nav a { margin: 0 15px; text-decoration: none; color: #1464dd; font-weight: bold; }
    nav a:hover { text-decoration: underline; }
    .container { margin: 20px auto; padding: 20px; background: #fff; border-radius: 5px; box-shadow: 0 3px 8px rgba(0,0,0,0.1); overflow-x: auto; }
    h2 { margin-top: 0; color: #1464dd; }
    .totals { margin-bottom: 10px; font-size: 14px; font-weight: bold; text-align: right; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
    th, td { border: 1px solid #ddd; padding: 8px; font-size: 14px; vertical-align: middle; }
    th { background: #f1f1f1; white-space: nowrap; }
    tr:hover { background: #f9f9f9; }
    .btn { padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; font-size: 13px; }
    .btn-danger { background: #e74c3c; color: #fff; }
    .btn-success { background: #27ae60; color: #fff; }
    .btn-warning { background: #f39c12; color: #fff; }
    .btn-reply { background: #1464dd; color: #fff; }
    .search-box, .small-search { margin-bottom: 20px; }
    .search-box input, .small-search input { padding: 8px; width: 350px; border: 1px solid #ccc; border-radius: 3px; }
    .small-search input { width: 250px; }
    .pending-payment { color: red; font-weight: bold; }
    .paid-payment { color: green; font-weight: bold; }
    .discipline-message { margin-top: 10px; color: red; font-weight: bold; }
  </style>
</head>
<body>
<header>Waliko Car Hire - Admin Panel</header>
<nav>
  <a href="#bookingsSection">Bookings</a>
  <a href="#usersSection">Users</a>
  <a href="#userSection">Activate User</a>
  <a href="#helpSection">Help Desk</a>
  <a href="#disciplineSection">Disciplinary</a>
</nav>


<!-- BOOKINGS -->
<div class="container" id="bookingsSection">
  <h2>All Bookings</h2>
  <div class="totals" id="totalBookings">Total Bookings: 0</div>
  <div class="search-box">
    <input type="text" id="searchBooking" placeholder="Search by Booking ID, Name, Phone or Registered User...">
  </div>
  <table id="bookingsTable">
    <thead>
      <tr>
        <th>Booking ID</th>
        <th>Full Name</th>
        <th>Car</th>
        <th>Phone</th>
        <th>Pickup</th>
        <th>End Date</th>
        <th>Status</th>
        <th>Registered User</th>
        <th>Timestamp</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- USERS -->
<div class="container" id="usersSection">
  <h2>Registered Users</h2>
  <div class="totals" id="totalUsers">Total Users: 0</div>
  <div class="small-search">
    <input type="text" id="searchUsers" placeholder="Search by Username, Email, or Phone...">
  </div>
  <table id="usersTable">
    <thead>
      <tr>
        <th>No.</th>
        <th>Username</th>
        <th>Email</th>
        <th>Phone</th>
        <th>Gender</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>
<!-- ACTIVATE USER -->
<div class="container" id="userSection">
  <h2>Activate User</h2>
  <div class="small-search">
    <input type="text" id="searchUser" placeholder="Search by Username, Email or Phone...">
  </div>
  <table id="userTable">
    <thead>
      <tr>
        <th>No.</th>
        <th>Username</th>
        <th>Email</th>
        <th>Phone</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      
          <button class="btn btn-success" onclick="window.location.href='activate.html'">Activate</button>
        </td>
      </tr>
      <!-- more rows will be loaded dynamically -->
    </tbody>
  </table>
</div>

<!-- HELP DESK -->
<div class="container" id="helpSection">
  <h2>Help Desk</h2>
  <div class="small-search">
    <input type="text" id="searchHelp" placeholder="Search by Username, Email, Phone or Message...">
  </div>
  <table id="helpTable">
    <thead>
      <tr>
        <th>No.</th>
        <th>Username</th>
        <th>Email</th>
        <th>Phone</th>
        <th>Message</th>
        <th>Reply</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- DISCIPLINE -->
<div class="container" id="disciplineSection">
  <h2>User Disciplinary Actions</h2>
  <div class="small-search">
    <input type="email" id="disciplineEmail" placeholder="Enter user email to suspend or expel">
    <button onclick="suspendUser()">Suspend</button>
    <button onclick="expelUser()">Expel</button>
  </div>
  <div id="disciplineMessage" class="discipline-message"></div>
  <h3>Suspended / Expelled Users</h3>
  <table id="disciplineTable">
    <thead>
      <tr>
        <th>No.</th>
        <th>Username</th>
        <th>Email</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
/* ------------------- BOOKINGS ------------------- */
function loadBookings() {
  let bookings = JSON.parse(localStorage.getItem("bookings")) || [];
  let users = JSON.parse(localStorage.getItem("allUsers")) || [];
  const tbody = document.querySelector("#bookingsTable tbody");
  tbody.innerHTML = "";
  bookings.forEach((b, index) => {
    let matchedUser = users.find(u => u.email === b.email || u.phone === b.phone);
    let dropdown = `<select>
      <option>Username: ${matchedUser ? matchedUser.username : b.username || "Guest"}</option>
      <option>Phone: ${matchedUser ? matchedUser.phone : b.phone}</option>
      ${matchedUser ? `<option>Email: ${matchedUser.email}</option>` : ''}
    </select>`;
    let timestamp = b.timestamp || "N/A";
    let statusText = b.status==="Approved" ? "Paid" : "Pending";
    let statusClass = b.status==="Approved" ? "paid-payment" : "pending-payment";
    let buttonText = b.status==="Approved" ? "Disapprove" : "Approve";
    let row = `<tr data-search="${b.bookingId} ${b.fullName} ${b.phone} ${matchedUser ? matchedUser.username.toLowerCase() : 'guest'}">
      <td>${b.bookingId || "N/A"}</td>
      <td>${b.fullName}</td>
      <td>${b.carName || "N/A"}</td>
      <td>${b.phone}</td>
      <td>${b.pickup}</td>
      <td>${b.endDate}</td>
      <td class="${statusClass}">${statusText}</td>
      <td>${dropdown}</td>
      <td>${timestamp}</td>
      <td>
        <button class="btn btn-success" onclick="toggleApproval(${index})">${buttonText}</button>
        <button class="btn btn-danger" onclick="deleteBooking(${index})">Delete</button>
      </td>
    </tr>`;
    tbody.innerHTML += row;
  });
  document.getElementById("totalBookings").innerText = `Total Bookings: ${bookings.length}`;
}

function toggleApproval(index) {
  let bookings = JSON.parse(localStorage.getItem("bookings")) || [];
  let booking = bookings[index];
  booking.status = booking.status === "Approved" ? "Pending" : "Approved";
  localStorage.setItem("bookings", JSON.stringify(bookings));
  loadBookings();
}

function deleteBooking(index) {
  let bookings = JSON.parse(localStorage.getItem("bookings")) || [];
  if (confirm(`Delete booking "${bookings[index].bookingId}"? This cannot be undone.`)) {
    bookings.splice(index,1);
    localStorage.setItem("bookings", JSON.stringify(bookings));
    loadBookings();
  }
}

document.getElementById("searchBooking").addEventListener("input", function() {
  let filter = this.value.toLowerCase();
  document.querySelectorAll("#bookingsTable tbody tr").forEach(row => {
    row.style.display = row.dataset.search.toLowerCase().includes(filter) ? "" : "none";
  });
});

/* ------------------- USERS ------------------- */
function loadUsers() {
  let users = JSON.parse(localStorage.getItem("allUsers")) || [];
  const tbody = document.querySelector("#usersTable tbody");
  tbody.innerHTML = "";
  users.forEach((user, i) => {
    let status = user.status || "Active";
    let row = `<tr>
      <td>${i+1}</td>
      <td>${user.username}</td>
      <td>${user.email}</td>
      <td>${user.phone}</td>
      <td>${user.gender}</td>
      <td>${status}</td>
    </tr>`;
    tbody.innerHTML += row;
  });
  document.getElementById("totalUsers").innerText = `Total Users: ${users.length}`;
}

document.getElementById("searchUsers").addEventListener("input", function() {
  let filter = this.value.toLowerCase();
  document.querySelectorAll("#usersTable tbody tr").forEach(row => {
    row.style.display = row.innerText.toLowerCase().includes(filter) ? "" : "none";
  });
});

/* ------------------- HELP DESK ------------------- */
function loadHelp() {
  let helpMessages = JSON.parse(localStorage.getItem("helpMessages")) || [];
  const tbody = document.querySelector("#helpTable tbody");
  tbody.innerHTML = "";
  helpMessages.forEach((msg,i) => {
    let row = `<tr data-search="${msg.username} ${msg.email} ${msg.phone} ${msg.message}">
      <td>${i+1}</td>
      <td>${msg.username || "Guest"}</td>
      <td>${msg.email || "N/A"}</td>
      <td>${msg.phone || "N/A"}</td>
      <td>${msg.message}</td>
      <td>${msg.reply || "No reply yet"}</td>
      <td>
        <button class="btn btn-reply" onclick="replyHelp(${i})">Reply</button>
        <button class="btn btn-danger" onclick="deleteHelp(${i})">Delete</button>
      </td>
    </tr>`;
    tbody.innerHTML += row;
  });
}

function replyHelp(index) {
  let helpMessages = JSON.parse(localStorage.getItem("helpMessages")) || [];
  let reply = prompt("Enter your reply:");
  if (reply) {
    helpMessages[index].reply = reply;
    localStorage.setItem("helpMessages", JSON.stringify(helpMessages));
    loadHelp();
  }
}

function deleteHelp(index) {
  let helpMessages = JSON.parse(localStorage.getItem("helpMessages")) || [];
  if (confirm("Delete this help message?")) {
    helpMessages.splice(index,1);
    localStorage.setItem("helpMessages", JSON.stringify(helpMessages));
    loadHelp();
  }
}

document.getElementById("searchHelp").addEventListener("input", function() {
  let filter = this.value.toLowerCase();
  document.querySelectorAll("#helpTable tbody tr").forEach(row => {
    row.style.display = row.dataset.search.toLowerCase().includes(filter) ? "" : "none";
  });
});

/* ------------------- DISCIPLINE ------------------- */
function suspendUser() { updateUserStatus("Suspended"); }
function expelUser() { updateUserStatus("Expelled"); }

function updateUserStatus(status) {
  let email = document.getElementById("disciplineEmail").value.trim().toLowerCase();
  if (!email) { alert("Enter user email."); return; }

  if (email === "guest@example.com") {
    document.getElementById("disciplineMessage").innerText = "guest@example.com is permanently blocked.";
    return;
  }

  let users = JSON.parse(localStorage.getItem("allUsers")) || [];
  let user = users.find(u => u.email.toLowerCase() === email);
  if (user) {
    user.status = status;
    localStorage.setItem("allUsers", JSON.stringify(users));
    document.getElementById("disciplineMessage").innerText = `${user.username} has been ${status}.`;
    document.getElementById("disciplineEmail").value = "";
    loadUsers();
    loadDisciplineTable();
  } else {
    alert("User not found.");
  }
}

function loadDisciplineTable() {
  let users = JSON.parse(localStorage.getItem("allUsers")) || [];
  const tbody = document.querySelector("#disciplineTable tbody");
  tbody.innerHTML = "";
  let disciplinedUsers = users.filter(u => u.status === "Suspended" || u.status === "Expelled" || u.email.toLowerCase() === "guest@example.com");
  disciplinedUsers.forEach((user, i) => {
    let isGuest = user.email.toLowerCase() === "guest@example.com";
    let row = `<tr>
      <td>${i+1}</td>
      <td>${user.username || "Guest"}</td>
      <td>${user.email}</td>
      <td>${isGuest ? "Blocked" : user.status}</td>
      <td>
        ${isGuest ? "<span style='color:red;font-weight:bold;'>Blocked</span>" : `<button class="btn btn-warning" onclick="unsuspendUser('${user.email}')">Unsuspend</button>`}
      </td>
    </tr>`;
    tbody.innerHTML += row;
  });
}

function unsuspendUser(email) {
  let users = JSON.parse(localStorage.getItem("allUsers")) || [];
  let user = users.find(u => u.email === email);
  if (user) {
    user.status = "Active";
    localStorage.setItem("allUsers", JSON.stringify(users));
    document.getElementById("disciplineMessage").innerText = `${user.username} is now Active.`;
    loadUsers();
    loadDisciplineTable();
  }
}

/* ------------------- AUTO REFRESH ------------------- */
function liveRefresh() {
  loadUsers();
  loadHelp();
  loadDisciplineTable();
  loadBookings();
}

/* ------------------- INIT ------------------- */
loadBookings();
loadUsers();
loadHelp();
loadDisciplineTable();

/* ðŸ”„ Refresh every 2s */
setInterval(liveRefresh, 2000);
</script>
</body>
</html>

